name: Allure Report

env:
    SOLUTION_FILE: Allure.Examples.NUnit3.sln
    BUILD_CONFIGURATION: Debug
    PROJECT_NAME: Allure.Examples.NUnit3

on:
  push:
    branches-ignore:
      - '!main'

jobs:
    autotests:
        name: Run tests and generate Allure Report
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4
  
            - name: Set up MSBuild
              uses: microsoft/setup-msbuild@v1

            - name: Set up NuGet
              uses: nuget/setup-nuget@v1

            - name: Navigate to Workspace
              run: cd $GITHUB_WORKSPACE

            - name: Create Build Directory
              run: mkdir _build

            - name: Restore NuGet packages
              run: |
                nuget restore ${{ env.SOLUTION_FILE }}

            - name: Build solution
              run: |
                msbuild.exe ${{ env.SOLUTION_FILE }} /nologo /nr:false /p:OutputPath="bin\${{ env.BUILD_CONFIGURATION }}\net48" /p:platform="Any CPU" /p:configuration="${{ env.BUILD_CONFIGURATION }}"

            - name: Test solution
              uses: microsoft/vstest-action
              with:
                testAssembly: ${{ env.PROJECT_NAME }}.dll
                searchFolder: ./tests/${{ env.PROJECT_NAME }}/bin/${{ env.BUILD_CONFIGURATION }}/net48
                runInParallel: true
              continue-on-error: true

            - name: Get Allure history
              uses: actions/checkout@v4
              if: always()
              continue-on-error: true
              with:
                ref: gh-pages
                path: gh-pages

            - name: Generate Allure Report
              uses: simple-elf/allure-report-action@v1.7
              if: always()
              with:
                allure_results: allure-results
                allure_history: allure-history
